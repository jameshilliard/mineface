-names = ['Accepted', 'Rejected', 'Stale', 'Discarded']
- @pools ||= []
- @pools.sort! {|a,b| a[:priority] <=> b[:priority]}
.panel
  %h3.panel-heading
    %i.icon-globe
    Pools
    %small.text-muted#devices_overview
      - unless @pools.empty?
        =pluralize(@pools.length, 'pool')
  %table.table.table-striped.panel-content
    %thead
      %tr
        %th.text-center Priority
        %th URL
        %th User
        %th Status
        %th=names.join('/')
        - if privileged?
          %th.text-center Options
    %tbody
      -if @pools.length == 0
        %tr
          %td{colspan:6}
            .text-center No pool information available
      -else
        -@pools.each do |pool|
          %tr{class: pool[:status] == :alive ? :success: pool[:status] == :disabled ? :warning: :danger, id: "pool#{pool[:id]}"}
            %td.text-center
              =pool[:priority]
              -if privileged?
                %span.priority-change{style: 'position: relative'}
                  - dolink = pool[:priority] != 0
                  - if dolink
                    =link_to pool_up_path(pool[:id]), remote: true, data: {refresh: 'pools', perform: 'Changing pool priority'}, class: 'pri-up' do
                      %i.icon-angle-up
                  -else
                    %a.disabled.pri-up
                      %i.icon-angle-up
                  - dolink = pool[:priority] < @pools.length-1
                  - if dolink
                    =link_to pool_down_path(pool[:id]), remote: true, data: {refresh: 'pools', perform: 'Changing pool priority'}, class: 'pri-down' do
                      %i.icon-angle-down
                  - else
                    %a.disabled.pri-down
                      %i.icon-angle-down

            %td{id: "pool#{pool[:id]}_url"}=pool[:url]
            %td{id: "pool#{pool[:id]}_user"}=pool[:user]
            %td=pool[:status].to_s.titleize
            %td
              :ruby
                keys = [:accepted, :rejected, :stale, :discarded]
                classes = %w(success warning warning danger)
                vals = keys.map{|k| pool[k]}
                total = vals.reduce(:+)
                perc = vals.map{|v| (v.to_f/total) * 100.0}
              .progress{style: 'margin-bottom: 0'}
                - keys.each_with_index do |key,index|
                  .progress-bar{style:"width: #{perc[index].round(2)}%", title: "#{names[index]}: #{vals[index]} (#{perc[index].round(2)}%)", class: "progress-bar-#{classes[index]}"}
            - if privileged?
              %td.text-center
                %span.option-link
                  =link_to(pool[:status] == :disabled ? enable_pool_path(pool[:id]): disable_pool_path(pool[:id]), remote: true, data: {refresh: 'pools', perform: 'Toggling pool'}) do
                    %i{class: "icon-check#{pool[:status] == :disabled ? '-empty': ''}", title: pool[:status] == :disabled ? 'Enable pool': 'Disable pool'}<>
                -#%span.option-link
                -#  =link_to(update_pool_path(pool[:id]), onclick: 'return false', data: {poolEdit: pool[:id]}) do
                -#    %span{title: 'Settings'}<>
                -#      %i.icon-wrench
                %span.option-link
                  =link_to(delete_pool_path(pool[:id]), remote: true, data: {confirm: 'Are you sure you want to delete this pool?', refresh: 'pools', perform: 'Deleting pool'}) do
                    %span{title: 'Delete'}<>
                      %i.icon-trash
  -if privileged?
    =link_to(new_pool_path, id: 'new_pool', class: 'btn btn-primary', data: {toggle: 'modal', target: '#pool_settings'}, onclick: 'return false') do
      %i.icon-plus
      Add pool
    %script
      $('#new_pool').attr('href', $('#new_pool').data('target'));